# âœ¨ MQTT æ¸¬è©¦è³‡æ–™ç™¼å¸ƒå™¨å·²å®Œæˆï¼

## ğŸ‰ å·²å®Œæˆçš„å·¥ä½œ

æˆ‘å·²ç¶“ç‚ºä½ å‰µå»ºäº†ä¸€å¥—å®Œæ•´çš„ MQTT æ¸¬è©¦è³‡æ–™ç™¼å¸ƒå·¥å…·ï¼Œç”¨æ–¼å‘ mosquitto ç™¼å¸ƒå¤§é‡ JSON è³‡æ–™ä»¥æ¸¬è©¦ InfluxDBã€‚

## ğŸ“¦ å‰µå»ºçš„æª”æ¡ˆ

```
/home/yoyo/mtig/mqtt_publisher/
â”œâ”€â”€ mqtt_test_publisher.py      âœ… æŒçºŒç™¼å¸ƒæ¸¬è©¦è³‡æ–™ï¼ˆæ¨¡æ“¬çœŸå¯¦å ´æ™¯ï¼‰
â”œâ”€â”€ mqtt_batch_publisher.py     âœ… æ‰¹é‡ç™¼å¸ƒå’Œæ­·å²è³‡æ–™å¡«å……å·¥å…·
â”œâ”€â”€ test_connection.py          âœ… MQTT é€£æ¥æ¸¬è©¦å·¥å…·
â”œâ”€â”€ Dockerfile                  âœ… Docker å®¹å™¨é…ç½®
â”œâ”€â”€ requirements.txt            âœ… Python ä¾è³´åˆ—è¡¨
â”œâ”€â”€ start.sh                    âœ… äº’å‹•å¼å•Ÿå‹•è…³æœ¬
â”œâ”€â”€ README.md                   âœ… å®Œæ•´ä½¿ç”¨æ–‡æª”
â””â”€â”€ QUICK_START.md              âœ… å¿«é€Ÿå…¥é–€æŒ‡å—
```

## âœ… å·²é©—è­‰åŠŸèƒ½

1. âœ… **é€£æ¥æ¸¬è©¦** - æˆåŠŸé€£æ¥åˆ° mosquitto (mtig_mosquitto:1883)
2. âœ… **è¨Šæ¯ç™¼é€** - æˆåŠŸç™¼é€æ¸¬è©¦ JSON è³‡æ–™åˆ° topic `app055/data`
3. âœ… **æ‰¹é‡ç™¼å¸ƒ** - æˆåŠŸç™¼é€ 100 æ¢æ¸¬è©¦æ¶ˆæ¯

## ğŸš€ ç«‹å³ä½¿ç”¨

### æ–¹å¼ä¸€ï¼šå¿«é€Ÿæ¸¬è©¦ï¼ˆæ¨è–¦ï¼‰

```bash
# 1. æ¸¬è©¦é€£æ¥
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python test_connection.py

# 2. ç™¼é€ 100 æ¢æ¸¬è©¦æ¶ˆæ¯
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python mqtt_batch_publisher.py \
  --mode batch --messages 100 --rate 20 --devices 5
```

### æ–¹å¼äºŒï¼šæŒçºŒç™¼å¸ƒï¼ˆæ¨¡æ“¬çœŸå¯¦å ´æ™¯ï¼‰

```bash
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python mqtt_test_publisher.py
```
æŒ‰ Ctrl+C å¯åœæ­¢

### æ–¹å¼ä¸‰ï¼šå¡«å……æ­·å²è³‡æ–™

```bash
# å¡«å…… 24 å°æ™‚æ­·å²è³‡æ–™ï¼ˆæ¯ 5 åˆ†é˜ä¸€ç­†ï¼‰
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python mqtt_batch_publisher.py \
  --mode historical --hours 24 --interval 5 --devices 10
```

## ğŸ¯ æ¸¬è©¦å ´æ™¯å»ºè­°

### 1. é©—è­‰æµç¨‹æ­£å¸¸ âœ…
```bash
# ç™¼é€å°‘é‡è³‡æ–™ç¢ºèªç³»çµ±é‹ä½œ
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python mqtt_batch_publisher.py \
  --mode batch --messages 100 --rate 10
```

### 2. æ€§èƒ½æ¸¬è©¦ ğŸ”¥
```bash
# æ¸¬è©¦æ¯ç§’ 100 æ¢æ¶ˆæ¯çš„è™•ç†èƒ½åŠ›
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python mqtt_batch_publisher.py \
  --mode batch --messages 1000 --rate 100
```

### 3. å£“åŠ›æ¸¬è©¦ ğŸš€
```bash
# æ¸¬è©¦ç³»çµ±æ¥µé™
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python mqtt_batch_publisher.py \
  --mode batch --messages 10000 --rate 200 --devices 20
```

### 4. å¡«å……è¦–è¦ºåŒ–è³‡æ–™ ğŸ“Š
```bash
# ç‚º Grafana æº–å‚™ä¸€é€±çš„è³‡æ–™
sudo docker run --rm --network mtig_backend \
  -e MQTT_BROKER=mtig_mosquitto \
  mqtt-publisher python mqtt_batch_publisher.py \
  --mode historical --hours 168 --interval 15 --devices 10
```

## ğŸ“Š ç™¼å¸ƒçš„è³‡æ–™æ ¼å¼

```json
{
  "id": "1",
  "name": "Plant_1",
  "ph": 6.8,
  "moisture": 55.3,
  "co2": 450.2,
  "o2": 20.5,
  "nh3": 2.3,
  "h2s": 0.8,
  "temp": 25.6,
  "humidity": 65.4,
  "timestamp": "2026-02-26T12:30:45.123456"
}
```

æ‰€æœ‰æ•¸å€¼éƒ½æ˜¯éš¨æ©Ÿç”¢ç”Ÿçš„æ¨¡æ“¬è³‡æ–™ï¼Œç¯„åœåˆç†ä¸”çœŸå¯¦ã€‚

## ğŸ” é©—è­‰è³‡æ–™æ˜¯å¦å¯«å…¥

### æ–¹æ³• 1ï¼šæŸ¥çœ‹ Telegraf æ—¥èªŒ
```bash
sudo docker logs -f mtig_telegraf
```
æ‡‰è©²çœ‹åˆ°è³‡æ–™è¢«æ¥æ”¶å’Œç™¼é€åˆ° InfluxDB

### æ–¹æ³• 2ï¼šæŸ¥è©¢ InfluxDB
```bash
# é€²å…¥ InfluxDB
sudo docker exec -it mtig_influxdb influx

# åŸ·è¡ŒæŸ¥è©¢
USE metrics
SELECT COUNT(*) FROM mqtt_consumer
SELECT * FROM mqtt_consumer ORDER BY time DESC LIMIT 10
```

### æ–¹æ³• 3ï¼šé€é Parser API
```bash
# æŸ¥è©¢æ‰€æœ‰è¨­å‚™
curl http://localhost:5000/api/all_data

# æŸ¥è©¢ç‰¹å®šè¨­å‚™æ­·å²
curl http://localhost:5000/api/history/1
```

## ğŸ“š æ–‡æª”æŒ‡å¼•

1. **å¿«é€Ÿå…¥é–€** â†’ [QUICK_START.md](QUICK_START.md)
   - å¸¸ç”¨å‘½ä»¤ç¯„ä¾‹
   - æ¸¬è©¦å ´æ™¯
   - ç›£æ§æ–¹æ³•

2. **å®Œæ•´æ–‡æª”** â†’ [README.md](README.md)
   - è©³ç´°ä½¿ç”¨èªªæ˜
   - æ‰€æœ‰åƒæ•¸èªªæ˜
   - æ•…éšœæ’é™¤

## ğŸ¨ åŠŸèƒ½ç‰¹è‰²

### ğŸŒŸ ä¸‰ç¨®ç™¼å¸ƒæ¨¡å¼

1. **æŒçºŒç™¼å¸ƒ** (`mqtt_test_publisher.py`)
   - æ¨¡æ“¬çœŸå¯¦è¨­å‚™æŒçºŒç™¼é€è³‡æ–™
   - å¯è¨­å®šç™¼é€é–“éš”
   - é©åˆé•·æ™‚é–“ç©©å®šæ€§æ¸¬è©¦

2. **æ‰¹é‡ç™¼å¸ƒ** (`mqtt_batch_publisher.py --mode batch`)
   - å¿«é€Ÿç™¼é€å¤§é‡è³‡æ–™
   - å¯æ§åˆ¶ç™¼é€é€Ÿç‡
   - é©åˆæ€§èƒ½æ¸¬è©¦å’Œå£“åŠ›æ¸¬è©¦

3. **æ­·å²è³‡æ–™** (`mqtt_batch_publisher.py --mode historical`)
   - å¡«å……éå»æ™‚é–“çš„è³‡æ–™
   - é©åˆè¦–è¦ºåŒ–æ¸¬è©¦
   - ç‚º Grafana å„€è¡¨æ¿æº–å‚™è³‡æ–™

### âš™ï¸ éˆæ´»é…ç½®

- æ”¯æ´ç’°å¢ƒè®Šæ•¸é…ç½®
- æ”¯æ´å‘½ä»¤åˆ—åƒæ•¸
- å¯è‡ªè¨‚è¨­å‚™æ•¸é‡ã€ç™¼é€é€Ÿç‡ã€æ™‚é–“ç¯„åœç­‰
- è³‡æ–™ç¯„åœçœŸå¯¦ä¸”å¯èª¿æ•´

### ğŸ³ Docker æ•´åˆ

- å®Œæ•´ Docker æ”¯æ´
- èˆ‡ç¾æœ‰ `mtig_backend` ç¶²è·¯æ•´åˆ
- é–‹ç®±å³ç”¨ï¼Œç„¡éœ€é¡å¤–å®‰è£

## ğŸ’¡ ä½¿ç”¨å»ºè­°

1. **é–‹å§‹å‰** - å…ˆåŸ·è¡Œé€£æ¥æ¸¬è©¦ç¢ºèªç³»çµ±æ­£å¸¸
2. **å°è¦æ¨¡é–‹å§‹** - å¾ 100 æ¢æ¶ˆæ¯é–‹å§‹æ¸¬è©¦
3. **é€æ­¥å¢åŠ ** - ç¢ºèªç³»çµ±ç©©å®šå¾Œå†å¢åŠ è² è¼‰
4. **ç›£æ§ç³»çµ±** - ä½¿ç”¨ `docker stats` å’Œ `htop` ç›£æ§è³‡æºä½¿ç”¨
5. **å¡«å……æ­·å²** - ç‚ºè¦–è¦ºåŒ–æº–å‚™å……è¶³çš„æ­·å²è³‡æ–™

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… æ¸¬è©¦å·¥å…·å·²å°±ç·’
2. ğŸ“Š é–‹å§‹ç™¼å¸ƒæ¸¬è©¦è³‡æ–™
3. ğŸ” åœ¨ Grafana ä¸­æŸ¥çœ‹è¦–è¦ºåŒ–çµæœ
4. ğŸ“ˆ æ ¹æ“šéœ€æ±‚èª¿æ•´åƒæ•¸

## ğŸŠ å®Œæˆï¼

ä½ ç¾åœ¨å¯ä»¥ï¼š
- âœ… æŒçºŒç™¼å¸ƒå¤§é‡ JSON æ¸¬è©¦è³‡æ–™
- âœ… é€²è¡Œæ€§èƒ½å’Œå£“åŠ›æ¸¬è©¦
- âœ… å¡«å……æ­·å²è³‡æ–™ä¾›è¦–è¦ºåŒ–ä½¿ç”¨
- âœ… é©—è­‰æ•´å€‹è³‡æ–™æµç¨‹ï¼ˆMQTT â†’ Telegraf â†’ InfluxDB â†’ Parser â†’ Grafanaï¼‰

ç¥æ¸¬è©¦é †åˆ©ï¼ğŸš€
